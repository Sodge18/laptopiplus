<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard - Istorija Laptopa</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body { font-family:'Inter',sans-serif; background:#f6f7f8; color:#111; }
.table { width:100%; border-collapse:collapse; font-size:0.875rem; }
.table th, .table td { border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
.table th { background:#197fe6; color:white; }
.hidden { display:none; }
.json-cell { font-family: monospace; white-space: pre-wrap; word-break: break-word; max-width:400px; }
.toggle-btn { cursor:pointer; color:#197fe6; text-decoration:underline; }
</style>
</head>
<body class="p-6">

<h1 class="text-2xl font-bold mb-4">Owner Dashboard - Istorija Laptopa</h1>

<!-- Login -->
<div id="loginDiv">
  <label class="block mb-1">Šifra:</label>
  <input type="password" id="ownerPassword" class="border p-2 rounded mb-2" placeholder="Unesite šifru">
  <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Prijava</button>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden overflow-x-auto">
  <table class="table mb-4 min-w-max">
    <thead>
      <tr>
        <th>ID</th>
        <th>Naziv</th>
        <th>Akcija</th>
        <th>Cijena</th>
        <th>Datum dodavanja</th>
        <th>Datum izmjene</th>
        <th>Detalji izmjene</th>
        <th>Vrijeme događaja</th>
        <th>Snapshot (JSON)</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <!-- Dinamički podaci -->
    </tbody>
  </table>
</div>

<script>
const OWNER_PASS = "siteowner123";

const loginDiv = document.getElementById("loginDiv");
const dashboard = document.getElementById("dashboard");
const loginBtn = document.getElementById("loginBtn");
const ownerPassword = document.getElementById("ownerPassword");
const historyBody = document.getElementById("historyBody");

let refreshInterval = null;

loginBtn.addEventListener("click", () => {
  if(ownerPassword.value === OWNER_PASS){
    loginDiv.classList.add("hidden");
    dashboard.classList.remove("hidden");
    fetchHistory();
    refreshInterval = setInterval(fetchHistory, 5000); // live refresh svakih 5 sekundi
  } else {
    Swal.fire({icon:'error', text:'Pogrešna šifra!'});
  }
});

async function fetchHistory(){
  try {
    const res = await fetch('https://products-api.sergej-kaldesic.workers.dev?history=true');
    const data = await res.json();
    const history = Array.isArray(data) ? data : [];

    // Sortiraj po timestampu (najnovije prvo)
    history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

    historyBody.innerHTML = history.map((entry, idx) => {
      // Snapshot uvijek sadrži sve podatke proizvoda
      const snapshot = {
        id: entry.snapshot?.id || entry.id || "-",
        title: entry.snapshot?.title || "-",
        price: entry.snapshot?.price || "Cena na upit",
        added: entry.snapshot?.added || "-",
        modified: entry.snapshot?.modified || "-",
        ...entry.snapshot // ostala polja ako postoje
      };

      const action = entry.action;
      const time = new Date(entry.timestamp).toLocaleString("sr-RS", {hour12:false});

      // Detalji izmjene
      let changeDetails = "-";
      if(action === "UPDATE" && snapshot._before && snapshot._after){
        const diffs = [];
        Object.keys(snapshot._after).forEach(key => {
          const before = snapshot._before[key] ?? "-";
          const after = snapshot._after[key] ?? "-";
          if(JSON.stringify(before) !== JSON.stringify(after)){
            diffs.push(`${key}: "${before}" → "${after}"`);
          }
        });
        if(diffs.length > 0) changeDetails = diffs.join("; ");
      }

      const jsonId = `json-${idx}`;
      return `
        <tr>
          <td>${snapshot.id}</td>
          <td>${snapshot.title}</td>
          <td>${action}</td>
          <td>${snapshot.price}</td>
          <td>${snapshot.added}</td>
          <td>${snapshot.modified}</td>
          <td>${changeDetails}</td>
          <td>${time}</td>
          <td>
            <span class="toggle-btn" onclick="document.getElementById('${jsonId}').classList.toggle('hidden')">Prikaži/sakrij</span>
            <pre id="${jsonId}" class="json-cell hidden">${JSON.stringify(snapshot, null, 2)}</pre>
          </td>
        </tr>
      `;
    }).join('');

  } catch(err){
    console.error(err);
    Swal.fire({icon:'error', text:'Greška pri učitavanju istorije!'});
  }
}

window.addEventListener("beforeunload", () => {
  if(refreshInterval) clearInterval(refreshInterval);
});
</script>

</body>
</html>
